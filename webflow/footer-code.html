<style>
  /* DHG Button Animations */
  @keyframes dhg-bounce {
    0%, 100% { transform: scale(1); }
    30% { transform: scale(1.4); }
    50% { transform: scale(0.9); }
    70% { transform: scale(1.15); }
  }

  @keyframes dhg-heart-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }

  @keyframes ghost-burn {
    0% { opacity: 1; transform: scale(1) translateY(0); filter: brightness(1); }
    30% { opacity: 1; transform: scale(1.02) translateY(-5px); filter: brightness(1.5) saturate(2); }
    60% { opacity: 0.7; transform: scale(0.95) translateY(-15px); filter: brightness(2) saturate(3); }
    100% { opacity: 0; transform: scale(0.8) translateY(-40px); filter: brightness(3) saturate(0); }
  }

  @keyframes ember-rise {
    0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
    100% { opacity: 0; transform: translateY(-120px) scale(0.3) rotate(45deg); }
  }

  .dhg.bounce { animation: dhg-bounce 0.5s ease; }
  .dhg.heart-pulse { animation: dhg-heart-pulse 0.4s ease 2; }

  .product-item.ghosted {
    animation: ghost-burn 0.8s ease-out forwards;
    pointer-events: none;
  }

  .ghost-ember {
    position: absolute;
    font-size: 20px;
    pointer-events: none;
    z-index: 100;
    animation: ember-rise 0.8s ease-out forwards;
  }

  /* Heart Login Prompt */
  .dhg-login-prompt {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #1a1a1a;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 12px 16px;
    width: 220px;
    z-index: 100;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    animation: prompt-in 0.25s ease;
  }

  @keyframes prompt-in {
    from { opacity: 0; transform: translateX(-50%) translateY(6px) scale(0.95); }
    to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
  }

  .dhg-login-prompt::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #1a1a1a;
  }

  .dhg-login-prompt p {
    color: rgba(255, 255, 255, 0.8) !important;
    font-size: 12px !important;
    margin: 0 0 10px 0 !important;
    line-height: 1.4 !important;
    text-align: center !important;
  }

  .dhg-login-prompt .prompt-btns {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .dhg-login-prompt .prompt-btn {
    padding: 5px 14px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }

  .dhg-login-prompt .prompt-yes {
    background: #e94580;
    color: #fff;
  }

  .dhg-login-prompt .prompt-no {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.6);
  }
</style>

<script>
// Supabase Init
const sb = window.supabase.createClient(
  'https://bfndiffxenplqfccwepd.supabase.co',
  'sb_publishable_butYC0KJo_rP8vddepfNDg_4FYJ9Kur'
);

// Section Expand/Collapse
document.querySelectorAll('[data-x]').forEach(el => {
  el.addEventListener('click', () => el.classList.toggle('open'));
});

// Card Flip - Flip Hint
document.querySelectorAll('.flip-hint').forEach(el => {
  el.addEventListener('click', () => {
    el.closest('.card-wrap').classList.add('flipped');
  });
});

// Card Flip - Flip Button (toggle both ways)
document.querySelectorAll('.flip-btn').forEach(el => {
  el.addEventListener('click', (e) => {
    e.preventDefault();
    el.closest('.card-wrap').classList.toggle('flipped');
  });
});

// DHG Buttons - Duck / Heart / Ghost
const ghostedSlugs = JSON.parse(localStorage.getItem('dhg_ghosted') || '[]');

// Hide previously ghosted products on load
ghostedSlugs.forEach(slug => {
  const card = document.querySelector(`.card-wrap[data-slug="${slug}"]`);
  if (card) {
    const item = card.closest('.product-item');
    if (item) item.style.display = 'none';
  }
});

document.querySelectorAll('.dhg').forEach(btn => {
  btn.addEventListener('click', async () => {
    const card = btn.closest('.card-wrap');
    const item = card?.closest('.product-item');
    const slug = card?.dataset.slug;
    const action = btn.dataset.a;
    const wasOn = btn.classList.contains('on');

    // Clear all buttons in this toggle group
    btn.parentElement.querySelectorAll('.dhg').forEach(b => b.classList.remove('on'));

    // Get user state
    const { data: { user } } = await sb.auth.getUser();

    // â”€â”€ GHOST: burn it down â”€â”€
    if (action === 'ghost' && !wasOn) {
      btn.classList.add('on');

      // Spawn fire/smoke embers
      if (item) {
        const emojis = ['ðŸ”¥','ðŸ”¥','ðŸ”¥','ðŸ’¨','ðŸ”¥','ðŸ’¨','ðŸ”¥','ðŸ”¥'];
        emojis.forEach((emoji, i) => {
          const ember = document.createElement('span');
          ember.className = 'ghost-ember';
          ember.textContent = emoji;
          ember.style.left = (Math.random() * 80 + 10) + '%';
          ember.style.bottom = (Math.random() * 30 + 10) + '%';
          ember.style.animationDelay = (i * 0.08) + 's';
          ember.style.fontSize = (16 + Math.random() * 14) + 'px';
          item.style.position = 'relative';
          item.appendChild(ember);
        });

        item.classList.add('ghosted');
        setTimeout(() => { item.style.display = 'none'; }, 850);
      }

      // Remember locally so it stays gone
      if (slug && !ghostedSlugs.includes(slug)) {
        ghostedSlugs.push(slug);
        localStorage.setItem('dhg_ghosted', JSON.stringify(ghostedSlugs));
      }

      // Save to Supabase if logged in
      if (user && slug) {
        await sb.from('votes').upsert({
          user_id: user.id, product_slug: slug, vote_type: 'ghost'
        }, { onConflict: 'user_id,product_slug' });
      }
      return;
    }

    // â”€â”€ HEART: community vote + profile save â”€â”€
    if (action === 'heart') {
      if (wasOn) {
        // Un-heart: remove vote + profile save
        if (user && slug) {
          await sb.from('votes').delete().match({ user_id: user.id, product_slug: slug });
          await sb.from('saved_products').delete().match({ user_id: user.id, product_slug: slug });
        }
        return;
      }

      btn.classList.add('on', 'heart-pulse');
      btn.addEventListener('animationend', () => btn.classList.remove('heart-pulse'), { once: true });

      if (user && slug) {
        // Community vote
        await sb.from('votes').upsert({
          user_id: user.id, product_slug: slug, vote_type: 'heart'
        }, { onConflict: 'user_id,product_slug' });
        // Profile save
        await sb.from('saved_products').upsert({
          user_id: user.id, product_slug: slug, vote: 'heart'
        }, { onConflict: 'user_id,product_slug' });
      } else if (!user) {
        // Gentle login suggestion for profile saves
        document.querySelectorAll('.dhg-login-prompt').forEach(p => p.remove());

        const prompt = document.createElement('div');
        prompt.className = 'dhg-login-prompt';
        prompt.innerHTML = `
          <p>Sign in to save your favorites across devices!</p>
          <div class="prompt-btns">
            <button class="prompt-btn prompt-yes">Sign up</button>
            <button class="prompt-btn prompt-no">No thanks</button>
          </div>
        `;

        btn.parentElement.style.position = 'relative';
        btn.parentElement.appendChild(prompt);

        prompt.querySelector('.prompt-yes').addEventListener('click', async () => {
          prompt.remove();
          await sb.auth.signInWithOAuth({ provider: 'google' });
        });

        prompt.querySelector('.prompt-no').addEventListener('click', () => {
          prompt.remove();
        });

        setTimeout(() => { if (prompt.parentElement) prompt.remove(); }, 5000);
      }
      return;
    }

    // â”€â”€ DUCK: bounce + vote â”€â”€
    if (action === 'duck') {
      if (!wasOn) {
        btn.classList.add('on', 'bounce');
        btn.addEventListener('animationend', () => btn.classList.remove('bounce'), { once: true });
      }

      if (user && slug) {
        if (wasOn) {
          await sb.from('votes').delete().match({ user_id: user.id, product_slug: slug });
        } else {
          await sb.from('votes').upsert({
            user_id: user.id, product_slug: slug, vote_type: 'duck'
          }, { onConflict: 'user_id,product_slug' });
        }
      }
      return;
    }
  });
});

// Gallery Swipe
document.querySelectorAll('.gallery-hero').forEach(gallery => {
  const track = gallery.querySelector('.gallery-hero-track');
  if (!track) return;

  let startX = 0;
  let scrollLeft = 0;
  let currentSlide = 0;
  const slideWidth = 268;
  const slides = track.querySelectorAll('.gallery-hero-slide');
  const maxSlide = slides.length - 1;

  track.addEventListener('touchstart', (e) => {
    startX = e.touches[0].pageX;
    scrollLeft = currentSlide * slideWidth;
    track.style.transition = 'none';
  });

  track.addEventListener('touchmove', (e) => {
    const x = e.touches[0].pageX;
    const diff = startX - x;
    track.style.transform = `translateX(-${scrollLeft + diff}px)`;
  });

  track.addEventListener('touchend', (e) => {
    const x = e.changedTouches[0].pageX;
    const diff = startX - x;
    track.style.transition = 'transform .3s cubic-bezier(.25,.46,.45,.94)';

    if (diff > 50 && currentSlide < maxSlide) {
      currentSlide++;
    } else if (diff < -50 && currentSlide > 0) {
      currentSlide--;
    }

    track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
  });

  let isDragging = false;

  track.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.pageX;
    scrollLeft = currentSlide * slideWidth;
    track.style.transition = 'none';
    track.style.cursor = 'grabbing';
  });

  track.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const x = e.pageX;
    const diff = startX - x;
    track.style.transform = `translateX(-${scrollLeft + diff}px)`;
  });

  track.addEventListener('mouseup', (e) => {
    if (!isDragging) return;
    isDragging = false;
    const diff = startX - e.pageX;
    track.style.transition = 'transform .3s cubic-bezier(.25,.46,.45,.94)';
    track.style.cursor = 'grab';

    if (diff > 50 && currentSlide < maxSlide) {
      currentSlide++;
    } else if (diff < -50 && currentSlide > 0) {
      currentSlide--;
    }

    track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
  });

  track.addEventListener('mouseleave', () => {
    if (isDragging) {
      isDragging = false;
      track.style.transition = 'transform .3s cubic-bezier(.25,.46,.45,.94)';
      track.style.cursor = 'grab';
      track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
    }
  });

  track.style.cursor = 'grab';
});

// Google OAuth
document.querySelectorAll('.sign-in-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    await sb.auth.signInWithOAuth({ provider: 'google' });
  });
});

document.querySelectorAll('.sign-out-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    await sb.auth.signOut();
    location.reload();
  });
});

// Quiz "Explore Products" handler â€” called by onclick in the inline quiz
// Maps quiz keys â†’ Finsweet fs-cmsfilter-field values
const quizToFilter = {
  skincare:    { field: 'category', values: ['Skincare'] },
  makeup:      { field: 'category', values: ['Makeup'] },
  body:        { field: 'category', values: ['Body'] },
  acne:        { field: 'skin-concern', values: ['Acne'] },
  antiaging:   { field: 'skin-concern', values: ['Wrinkles', 'Fine Lines'] },
  brightening: { field: 'skin-concern', values: ['Dullness', 'Hyperpigmentation'] },
  sensitivity: { field: 'skin-concern', values: ['Sensitivity', 'Redness'] },
  dryness:     { field: 'skin-type', values: ['Dry', 'Dehydrated'] },
};

window.sendResults = function() {
  // Gather hearted/ghosted from the quiz's global answers + QUESTIONS
  const hearted = [], ghosted = [];
  if (typeof QUESTIONS !== 'undefined' && typeof answers !== 'undefined') {
    QUESTIONS.forEach(q => {
      const a = answers[q.key];
      if (a === 'heart') hearted.push(q.key);
      if (a === 'ghost') ghosted.push(q.key);
    });
  }

  // Save to localStorage
  localStorage.setItem('dhg_quiz_answers', JSON.stringify(answers || {}));
  localStorage.setItem('dhg_quiz_hearted', JSON.stringify(hearted));
  localStorage.setItem('dhg_quiz_ghosted', JSON.stringify(ghosted));

  // Close the quiz modal
  const modal = document.querySelector('#dhg-modal-overlay');
  if (modal) {
    modal.classList.remove('dhg-open');
    modal.style.display = 'none';
  }

  // Apply Finsweet filters from hearted answers
  const filtersToApply = {};
  hearted.forEach(key => {
    const mapping = quizToFilter[key];
    if (!mapping) return;
    if (!filtersToApply[mapping.field]) filtersToApply[mapping.field] = [];
    filtersToApply[mapping.field].push(...mapping.values);
  });

  Object.entries(filtersToApply).forEach(([field, values]) => {
    values.forEach(value => {
      const filterEls = document.querySelectorAll(
        `[fs-cmsfilter-field="${field}"]`
      );
      filterEls.forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') {
          if (el.value === value && !el.checked) el.click();
        } else if (el.textContent.trim() === value) {
          el.click();
        }
      });
    });
  });

  // Scroll to products
  setTimeout(() => {
    const productList = document.querySelector('.product-list-wrapper');
    if (productList) {
      productList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 300);
};

// Auth State Listener
sb.auth.onAuthStateChange((event, session) => {
  const signInBtns = document.querySelectorAll('.sign-in-btn');
  const signOutBtns = document.querySelectorAll('.sign-out-btn');

  if (session) {
    signInBtns.forEach(btn => btn.style.display = 'none');
    signOutBtns.forEach(btn => btn.style.display = 'block');
  } else {
    signInBtns.forEach(btn => btn.style.display = 'block');
    signOutBtns.forEach(btn => btn.style.display = 'none');
  }
});
</script>
